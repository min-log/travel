<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/basic}">
<th:block layout:fragment="content">
    <div class="content_nav"  th:object="${category}">
        <!-- start : navbar -->
        <th:block th:replace="layout/navBarTravelView::navBarTravelView"></th:block>
        <div class="content" style="padding:0;">
            <div id="mapMenuWrap" class="bg_white" style="display:none">
                <ul id="placesList" class="scrollBar"></ul>
                <div id="pagination"></div>
            </div>
            <div class="map_wrap">
                <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
                <!-- 지도 확대, 축소 컨트롤 div 입니다 -->
                <div class="custom_zoomcontrol radius_border">
                    <span onclick="zoomIn()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png" alt="확대"></span>
                    <span onclick="zoomOut()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png" alt="축소"></span>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=613aa2f615dd1e9e1195bc49e034884a&libraries=services,clusterer,drawing"></script>
    <script>

        let markers=[];
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 10 // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다


        // 지도 확대, 축소 컨트롤에서 확대 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
        function zoomIn() {
            map.setLevel(map.getLevel() - 1);
        }

        // 지도 확대, 축소 컨트롤에서 축소 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
        function zoomOut() {
            map.setLevel(map.getLevel() + 1);
        }


        // 지도 이동
        function setCenter(y,x) {
            // 이동할 위도 경도 위치를 생성합니다
            var moveLatLon = new kakao.maps.LatLng(y, x);

            // 지도 중심을 이동 시킵니다
            //map.setCenter(moveLatLon);
            // 지도 중심을 부드럽게 이동시킵니다
            // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
            map.panTo(moveLatLon);
        }


        let infowindow = new kakao.maps.InfoWindow({zIndex:1});







        function addMarker(position, idx,id) {
            //기본 imgOptions
            imageSrc = '/img/icon_map_00.png'; // 마커 이미지 url, 스프라이트 이미지를 씁니다
            imageSize = new kakao.maps.Size(36, 37);  // 마커 이미지의 크기
            spriteSize = new kakao.maps.Size(36, 37);
            spriteOrigin= new kakao.maps.Point(0,0);
            offset = new kakao.maps.Point(18, 37);

            myMarker(id); //내 마커 표시

            var imgOptions =  {
                    spriteSize : spriteSize, // 스프라이트 이미지의 크기
                    spriteOrigin : spriteOrigin, // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                    offset: offset // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                },
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                marker = new kakao.maps.Marker({
                    position: position, // 마커의 위치
                    image: markerImage
                });

            marker.setMap(map); // 지도 위에 마커를 표출합니다
            markers.push(marker);  // 배열에 생성된 마커를 추가합니다

            return marker;
        }


        var positions = [];


        setTimeout(function() {
            mapSet();
        }, 100);
                // 마커를 표시할 위치와 내용을 가지고 있는 객체 배열입니다

        function mapSet(){
                removeMarker();
                console.log("마크 리스트 --------------");
                //일정 선택시 변경되는 imgOptions
                $("#sortable li").each(function (i,box){
                    let content = '<div class="map_mark_info">';
                        content += '<div class="map_mark_top mb-3">';
                        content +=  '   <h5 class="place_name">'+ $(box).find(".place_name").text()  + '</h5>';
                        content +=  '   <a href="javascript:infowindow.close()" class="btn btn-close"></a>'
                        content += '</div>'

                        content += '    <p class="road_address_name">' + $(box).find(".road_address_name").text() + '</p>' +
                            '   <p class="jibun gray address_name">' +  $(box).find(".address_name").text() + '</p>';
                    content += '</div>';

                    var positionsItem = {
                        content : content,
                        latlng: new kakao.maps.LatLng($(box).attr('data-map-y'), $(box).attr('data-map-x')),
                        itemIndexArr:$(box).attr('data-index'),
                        mapIdArr :$(box).attr('data-map-id'),
                        x: $(box).attr('data-map-x'),
                        y: $(box).attr('data-map-y')

                    }
                    positions.push(positionsItem);
                });



                for (var i = 0; i < positions.length; i ++) {

                    imageSize = new kakao.maps.Size(36, 37);  // 마커 이미지의 크기
                    imageSrc ='/img/marker_number_blue.png';

                    var imgOptions =  {
                        spriteSize : new kakao.maps.Size(35, 691), // 스프라이트 이미지의 크기
                        spriteOrigin : new kakao.maps.Point(0, (positions[i].itemIndexArr*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                        offset: new kakao.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                    },
                    markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                    marker = new kakao.maps.Marker({
                        map: map,
                        position: positions[i].latlng , // 마커의 위치
                        image: markerImage
                    });

                    // 마커에 표시할 인포윈도우를 생성합니다
                    infowindow.setContent(positions[i].content);


                    // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
                    // 이벤트 리스너로는 클로저를 만들어 등록합니다
                    // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
                    kakao.maps.event.addListener(marker, 'click', makeOverListener(map, marker, infowindow , positions[i]));

                    $("#sortable li").onclick = function (){
                        let i = $(this).attr('data-index');
                        console.log("i : "+i)
                        infowindow.setContent(positions[i].content);
                        makeOverListener(map, marker, infowindow , positions[i]);
                    }


                }


        }


        // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
        function makeOverListener(map, marker, infowindow , position) {
            return function() {
                setCenter(position.y,position.x);
                infowindow.open(map, marker);


            };
        }

        // 인포윈도우를 닫는 클로저를 만드는 함수입니다
        function makeOutListener(infowindow) {
            return function() {
                infowindow.close();
            };
        }


        // 지도 위에 표시되고 있는 마커를 모두 제거합니다
        function removeMarker() {
            console.log("기존 마커 제거 ")
            for ( var i = 0; i < markers.length; i++ ) {
                markers[i].setMap(null);
            }
            markers = [];
        }



    </script>



</th:block>
</html>

