<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic}">
<th:block layout:fragment="content">



    <div class="content_nav"  th:object="${board}">
        <!-- start : navbar -->
        <th:block th:replace="layout/navBarTravelPost::navBarTravelPost"></th:block>
        <div class="content">
            <h3 class="tit text-center">ê¸€ì“°ê¸°</h3>
            <form class="mt-2" id="BoardForm" method="post" enctype="multipart/form-data">
                <!--start ì‹œíë¦¬í‹° ì¶”ê°€ -->
                <input class="csrf_input" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input class="csrf_input" type="hidden" th:name="${_csrf.getHeaderName()}">
                <!--end ì‹œíë¦¬í‹° ì¶”ê°€ -->

                <input th:field="*{boardNo}" th:name="*{boardNo}" id="boardNo" type="text" th:type="hidden">
                <input th:field="*{boardCategoryNo}" th:name="*{boardCategoryNo}" id="boardCategoryNo"  type="text" th:type="hidden">
                <input th:field="*{boardItemDay}" th:name="*{boardItemDay}" id="boardItemDay"  type="text" value="itemNum" th:type="hidden">
                <table class="board-top">
                    <colgroup>
                        <col style="width:20%">
                        <col style="width:80%">
                    </colgroup>
                    <tbody>
                        <tr>
                            <th>ì œëª©</th>
                            <td>
                                <input th:field="*{boardTit}" th:name="*{boardTit}" id="boardTit" class="form-control" type="text">
                            </td>
                        </tr>
                        <tr>
                            <th>ì—¬í–‰ ì¼ì</th>
                            <td><input th:name="*{boardTravelDate}" id="boardTravelDate" class="dayName form-control" th:value="${days.dayInfo[0]}" readonly /></td>
                        </tr>

                        <tr id="thumbnailWarp">
                            <th>ì¸ë„¤ì¼</th>
                            <td>
                                <div class="userimg_wrap">
                                    <div class="userimg_box">
                                        <img id="preview" src="" alt="">
                                    </div>
                                    <label for="userImg" class="btn btn-dark btn-sm ">
                                         ì„ íƒí•˜ê¸°ğŸ‘†
                                    </label>
                                    <input type="file" name="file" id="userImg" accept="image/*" multiple="multiple">
                                </div>
                            </td>
                        </tr>

                    </tbody>
                </table>
                <div id="editor_con">
                    <div id="summernote"></div>
                </div>
                <button class="btn btn-primary mt-3 w-100" type="button" onclick="submitPost()">ì €ì¥í•˜ê¸°</button>
            </form>
        </div>
    </div>
    <!-- í˜ì´ì§€ ë¡œë”©ì‹œ ì´ˆê¸°í™” -->

    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>

    <script type="text/javascript">
        let file = document.querySelector('#userImg');
        let fileList = null;
        $(document).ready(function (){
            $("#boardItemDay").val(1);
        });

        // ê²Œì‹œíŒ
        $('#summernote').summernote({
            placeholder: 'ê¸°ì–µì— ë‚¨ëŠ” ì—¬í–‰ ìˆœê°„ë“¤ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.',
            tabsize: 2,
            height: 300,
            minHeight: null,             // ìµœì†Œ ë†’ì´
            maxHeight: null,             // ìµœëŒ€ ë†’ì´
            focus: true,                  // ì—ë””í„° ë¡œë”©í›„ í¬ì»¤ìŠ¤ë¥¼ ë§ì¶œì§€ ì—¬ë¶€
            lang: "ko-KR",					// í•œê¸€ ì„¤ì •
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                onImageUpload: function (files, editor, welEditable) {
                    // íŒŒì¼ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì—…ë¡œë“œë¥¼ ìœ„í•´ ë°˜ë³µë¬¸ ì‚¬ìš©)
                    for (var i = files.length - 1; i >= 0; i--) {
                        var fileName = files[i].name
                        // ì´ë¯¸ì§€ alt ì†ì„± ì‚½ì¼ì„ ìœ„í•œ ì„¤ì •
                        var caption = prompt('ì´ë¯¸ì§€ ì„¤ëª… :', fileName)
                        if (caption == '') {
                            caption = 'ì´ë¯¸ì§€'
                        }
                        uploadSummernoteImageFile(files[i], this, caption)
                    }
                },
            }

        });


        /* Post ë©”ì„œë“œ ì‹œíë¦¬í‹° ì¶”ê°€ */
        let headerName = document.getElementsByClassName("csrf_input")[1].getAttribute("name");
        let token = document.getElementsByClassName("csrf_input")[0].getAttribute("value");

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜ ajax í™œìš©
        function uploadSummernoteImageFile(file, el, caption) {
            let formData = new FormData();
            formData.append('file', file)
            console.log(formData);
            $.ajax({
                type: 'post',
                data: formData,
                url: "/file/categoryImgSave",
                dataType: 'json',
                contentType: false,
                enctype: 'multipart/form-data',
                processData: false,
                async: true, //ë™ê¸°, ë¹„ë™ê¸° ì—¬ë¶€
                cache :false, // ìºì‹œ ì—¬ë¶€
                beforeSend : function(xhr)
                {
                    xhr.setRequestHeader(headerName, token);
                },
                focus: true,
                success: function (data) {
                    $(el).summernote(
                        'editor.insertImage',
                        data.url,
                        function ($image) {
                            $image.attr('alt', caption) // ìº¡ì…˜ ì •ë³´ë¥¼ ì´ë¯¸ì§€ì˜ alt ì†ì„±ì— ì„¤ì •
                        }
                    )
                },
                error:function (data){
                    console.log(data)
                }
            });

        }




        // ê²Œì‹œíŒ ì €ì¥
        function submitPost(){

            // title,ì¸ë„¤ì¼,categoryë²ˆí˜¸,item ìˆœì„œë²ˆí˜¸, content ê°€ì§€ê³ ì™€ì„œ formdata ë¡œ ì „ì†¡
            //th:id="*{boardCategoryNo}"
            let boardCategoryNo = document.getElementById('boardCategoryNo').value;
            let boardItemDay = document.getElementById('boardItemDay').value;
            let boardTravelDate = document.getElementById('boardTravelDate').value;
            let boardTit = document.getElementById('boardTit').value;
            let content = $('#summernote').summernote('code');


            console.log("boardCategoryNo :" + boardCategoryNo);
            console.log("content :" + content);

            //json í˜•íƒœ ë°ì´í„° ì „ë‹¬
            let itemCon = {
                "boardNo":null,
                "boardCategoryNo":boardCategoryNo,
                "boardItemDay": boardItemDay,
                "boardTravelDate": boardTravelDate,
                "boardTit": boardTit,
                "boardContent": content,
                "boardImg":null,
                "createdAt":null
            }

            let formData = new FormData;
            formData.append('itemCon', new Blob([JSON.stringify(itemCon)] , {type: "application/json"}));
            if(fileList != null) formData.append("boardFile", fileList[0]); // ì¸ë„¤ì¼ íŒŒì¼ ê°ì²´

            //console.log(fileList[0]);

            $.ajax({
                type: 'post',
                data: formData,
                url: "/board/postSave",
                dataType: 'json',
                contentType: false,
                enctype: 'multipart/form-data',
                processData: false,
                async: true, //ë™ê¸°, ë¹„ë™ê¸° ì—¬ë¶€
                cache :false, // ìºì‹œ ì—¬ë¶€
                beforeSend : function(xhr)
                {
                    xhr.setRequestHeader(headerName, token);
                },
                success:function (data) {
                    console.log(data)
                    let boardViewPage = "/travel/postView?no=" + data.boardCategoryNo + "&boardNo="+data.boardNo;

                    if(data == null) {
                        alert("ì €ì¥ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }else{
                        alert("ì €ì¥ì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤." );
                        location.replace(boardViewPage);
                    }
                },
                error:function (data) {
                    alert("ì €ì¥ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ ì£¼ì„¸ìš”.");
                }
            });




        }


        <!-- start í”„ë¡œí•„ ì´ë¯¸ì§€ -->
        file.onchange = function () {
            fileList = file.files ;
            // ì½ê¸°
            var reader = new FileReader();
            reader.readAsDataURL(fileList[0]);
            //ë¡œë“œ í•œ í›„
            reader.onload = function  () {
                document.querySelector('#preview').src = reader.result ;
            };
        };
        <!-- end í”„ë¡œí•„ ì´ë¯¸ì§€ -->
    </script>


</th:block>
</html>