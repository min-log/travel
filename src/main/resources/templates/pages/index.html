<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/basic}">
<th:block layout:fragment="content">

    <div class="d-grid gap-2" style="grid-template-columns: 2fr 1fr;">

        <div class="map_wrap">
          <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>

          <div id="menu_wrap" class="bg_white">
            <hr>
            <ul id="placesList"></ul>
            <div id="pagination"></div>
          </div>
        </div>
        <!-- map_wrap -->
        <!-- content -->
        <div class="travel_list">
            <h2>Travel Log</h2>
            <a href="#">상세 보기 +</a>
            <ul>

            </ul>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel"> 여행이름 </h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="">
                        <input class="item_id" value="" type="hidden" />
                        <table>
                            <colgroup>
                                <col style="width:100px;">
                                <col style="width:calc(100% - 100px);">
                            </colgroup>
                            <tbody>
                                <tr>
                                    <th>Day</th>
                                    <td>
                                        <input name="travel_day" class="travel_day" type="number" value="1">
                                    </td>
                                </tr>
                                <tr>
                                    <th>장소명</th>
                                    <td>
                                        <input name="place_name" class="place_name" type="text" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <th>주소</th>
                                    <td>
                                        <input name="road_address_name" class="road_address_name" type="text" readonly>
                                        <input name="address_name" class="address_name" type="text" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <th>phone</th>
                                    <td>
                                        <input name="phone" class="phone" type="text" value="1" readonly>
                                    </td>
                                </tr>
                                <tr>
                                    <th>URL</th>
                                    <td>
                                        <input name="place_url" class="place_url" type="text" value="1" readonly>
                                    </td>
                                </tr>

                                <tr>
                                    <th>시간</th>
                                    <td>
                                        <li>도착: <input class="time" name="time1" type="text" placeholder="7:00"/> </li>
                                        <li>출발: <input type="text" name="time2" placeholder="7:00"/> </li>
                                    </td>
                                </tr>
                                <tr>
                                    <th>여행지 정보 및 운영 시간</th>
                                    <td>
                                        <textarea name="travel_content" class="travel_content"></textarea>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">다시 작성하기 </button>
                    <button type="button" class="btn btn-primary" onclick="itemSave()" >저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=613aa2f615dd1e9e1195bc49e034884a&libraries=services,clusterer,drawing"></script>
    <script>
    // 마커를 담을 배열입니다
    var markers = [];

    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
              center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
              level: 3 // 지도의 확대 레벨
            };

    // 지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);
// ------------ 내 위치
// ----------- 검색
    // 장소 검색 객체를 생성합니다
    var ps = new kakao.maps.services.Places();

    // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
    var infowindow = new kakao.maps.InfoWindow({zIndex:1});

    // 키워드로 장소를 검색합니다
    searchPlaces();

    // 키워드 검색을 요청하는 함수입니다
    function searchPlaces() {

      var keyword = document.getElementById('keyword').value;

      if (!keyword.replace(/^\s+|\s+$/g, '')) {
        alert('키워드를 입력해주세요!');
        return false;
      }

      // 장소검색 객체를 통해 키워드로 장소검색을 요청합니다
      ps.keywordSearch( keyword, placesSearchCB);
    }

    // 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
    function placesSearchCB(data, status, pagination) {
      if (status === kakao.maps.services.Status.OK) {

        // 정상적으로 검색이 완료됐으면
        // 검색 목록과 마커를 표출합니다
        displayPlaces(data);

        // 페이지 번호를 표출합니다
        displayPagination(pagination);

      } else if (status === kakao.maps.services.Status.ZERO_RESULT) {

        alert('검색 결과가 존재하지 않습니다.');
        return;

      } else if (status === kakao.maps.services.Status.ERROR) {

        alert('검색 결과 중 오류가 발생했습니다.');
        return;

      }
    }

    // 검색 결과 목록과 마커를 표출하는 함수입니다
    function displayPlaces(places) {

      var listEl = document.getElementById('placesList'),
              menuEl = document.getElementById('menu_wrap'),
              fragment = document.createDocumentFragment(),
              bounds = new kakao.maps.LatLngBounds(),
              listStr = '';

      // 검색 결과 목록에 추가된 항목들을 제거합니다
      removeAllChildNods(listEl);

      // 지도에 표시되고 있는 마커를 제거합니다
      removeMarker();

      for ( var i=0; i<places.length; i++ ) {

        // 마커를 생성하고 지도에 표시합니다
        var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x),
                marker = addMarker(placePosition, i),
                itemEl = getListItem(i, places[i]); // 검색 결과 항목 Element를 생성합니다

        // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
        // LatLngBounds 객체에 좌표를 추가합니다
        bounds.extend(placePosition);

        // 마커와 검색결과 항목에 mouseover 했을때
        // 해당 장소에 인포윈도우에 장소명을 표시합니다
        // mouseout 했을 때는 인포윈도우를 닫습니다
        (function(marker, title) {
          kakao.maps.event.addListener(marker, 'click', function() {
            displayInfowindow(marker, title);
          });

          // kakao.maps.event.addListener(marker, 'mouseout', function() {
          //   infowindow.close();
          // });

          itemEl.onmouseover =  function () {
            displayInfowindow(marker, title);
          };

          itemEl.onmouseout =  function () {
            infowindow.close();
          };
        })(marker, places[i].place_name);

        fragment.appendChild(itemEl);
      }


        function markeClose (){
            infowindow.close();
        }

      // 검색결과 항목들을 검색결과 목록 Element에 추가합니다
      listEl.appendChild(fragment);
      menuEl.scrollTop = 0;

      // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
      map.setBounds(bounds);
    }

    // 검색결과 항목을 Element로 반환하는 함수입니다
    function getListItem(index, places) {

      var el = document.createElement('li'),
          itemStr = '<span class="markerbg marker_' + (index+1) + '"></span>' +
          '<div class="info" id="triveItem'+ places.id +'">' +
              '   <h5 class="place_name">' + places.place_name + '</h5>';
                if (places.road_address_name) {
                itemStr += '    <span class="road_address_name">' + places.road_address_name + '</span>' +
                    '   <span class="jibun gray address_name">' +  places.address_name  + '</span>';
                } else {
                itemStr += '    <span class="address_name">' +  places.address_name  + '</span>';
                }

                if (places.place_url) {
                itemStr += '    <span><a class="place_url" href="' + places.place_url + '" target="_blank">' + places.place_url + '</a></span>' ;
                }

                itemStr += '  <span class="tel phone">' + places.phone  + '</span>';
                itemStr += '<button type="button" class="btn btn-primary item-add" data-id="'+ places.id +'' +
                    '" data-bs-toggle="modal" data-bs-target="#staticBackdrop">' +
                    '  추가하기 ' +
                    '</button>' +
                '</div>';
        el.innerHTML = itemStr;
      el.className = 'item';

      return el;
    }

    // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
    function addMarker(position, idx, title) {
      var imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_blue.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
              imageSize = new kakao.maps.Size(36, 37),  // 마커 이미지의 크기
              imgOptions =  {
                spriteSize : new kakao.maps.Size(36, 691), // 스프라이트 이미지의 크기
                spriteOrigin : new kakao.maps.Point(0, (idx*46)+10), // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                offset: new kakao.maps.Point(13, 37) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
              },
              markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
              marker = new kakao.maps.Marker({
                position: position, // 마커의 위치
                image: markerImage
              });

      marker.setMap(map); // 지도 위에 마커를 표출합니다
      markers.push(marker);  // 배열에 생성된 마커를 추가합니다

      return marker;
    }

    // 지도 위에 표시되고 있는 마커를 모두 제거합니다
    function removeMarker() {
      for ( var i = 0; i < markers.length; i++ ) {
        markers[i].setMap(null);
      }
      markers = [];
    }

    // 검색결과 목록 하단에 페이지번호를 표시는 함수입니다
    function displayPagination(pagination) {
      var paginationEl = document.getElementById('pagination'),
              fragment = document.createDocumentFragment(),
              i;

      // 기존에 추가된 페이지번호를 삭제합니다
      while (paginationEl.hasChildNodes()) {
        paginationEl.removeChild (paginationEl.lastChild);
      }

      for (i=1; i<=pagination.last; i++) {
        var el = document.createElement('a');
        el.href = "#";
        el.innerHTML = i;

        if (i===pagination.current) {
          el.className = 'on';
        } else {
          el.onclick = (function(i) {
            return function() {
              pagination.gotoPage(i);
            }
          })(i);
        }

        fragment.appendChild(el);
      }
      paginationEl.appendChild(fragment);
    }

    // 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
    // 인포윈도우에 장소명을 표시합니다
    function displayInfowindow(marker, title ,index ,places) {
      var content =
          '<div style="padding:5px;z-index:1;">' + title + '</div>' +
          '<a href="#"> 추가 </a> <a href="#"> 제거 </a>';

      infowindow.setContent(content);
      infowindow.open(map, marker);
    }

    // 검색결과 목록의 자식 Element를 제거하는 함수입니다
    function removeAllChildNods(el) {
      while (el.hasChildNodes()) {
        el.removeChild (el.lastChild);
      }
    }

    </script>

<script>
    $(document).on("click", ".item-add", function () {
        let i = $(this).data('id');
        let Iitem = "#triveItem" + i;
        let item = $(Iitem);

        console.log(item);
        let item_id = i;
        let place_name =$(item).find('.place_name').html();
        let road_address_name =$(item).find('.road_address_name').html();
        let address_name =$(item).find('.address_name').html();
        let place_url =$(item).find('.place_url').html();
        let phone =$(item).find('.phone').html();

        $('.modal-body .item_id').val(i);
        $('.modal-body .place_name').val(place_name);
        $('.modal-body .road_address_name').val(road_address_name);
        $('.modal-body .address_name').val(address_name);
        $('.modal-body .place_url').val(place_url);
        $('.modal-body .phone').val(phone);

    });



    function itemSave(){
        let item_id = $('.modal-body .item_id').val();
        let travel_day = $('.modal-body .travel_day').val();
        let place_name = $('.modal-body .place_name').val();
        let road_address_name = $('.modal-body .road_address_name').val();
        let address_name = $('.modal-body .address_name').val();
        let place_url = $('.modal-body .place_url').val();
        let phone = $('.modal-body .phone').val();
        let travel_content = $('.modal-body .travel_content').val();

        $.ajax({
            url : "${contextPath}/main",
            type : "post",
            data : {
                "travel_day" : travel_day,
                "travelId" : item_id,
                "travel_content" : travel_content,
                "place_name" : place_name,
                "road_address_name":road_address_name,
                "address_name":address_name,
                "place_url":place_url,
                "phone":phone
            },
            success : function(result){
                // 자바에서 결과값 전달 받아서 실행
                console.log("성공")
            },
            error : function(){ alert("error"); }
        });
    }
</script>



</th:block>
</html>

