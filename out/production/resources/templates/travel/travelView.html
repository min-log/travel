<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/basic}">
<th:block layout:fragment="content">
    <div class="content_nav"  th:object="${category}">
        <!-- start : navbar -->
        <th:block th:replace="layout/navBarTravelView::navBarTravelView"></th:block>
        <div class="content" style="padding:0;">
            <div id="mapMenuWrap" class="bg_white" style="display:none">
                <ul id="placesList" class="scrollBar"></ul>
                <div id="pagination"></div>
            </div>
            <div class="map_wrap">
                <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
                <!-- 지도 확대, 축소 컨트롤 div 입니다 -->
                <div class="custom_zoomcontrol radius_border">
                    <span onclick="zoomIn()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png" alt="확대"></span>
                    <span onclick="zoomOut()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png" alt="축소"></span>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=613aa2f615dd1e9e1195bc49e034884a&libraries=services,clusterer,drawing"></script>
    <script>
    $(document).ready(function () {



        ////https://stackoverflow.com/questions/13286913/google-maps-setmap-is-not-a-function

        // 마커를 담을 배열입니다
        var markers = [];
        var positions = []; // 내 리스트 배열

        let imageSrc = '/img/icon_map_00.png'; // 마커 이미지 url, 스프라이트 이미지를 씁니다
        let imageSize, spriteSize, spriteOrigin,offset;


        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567), // 지도의 중심좌표
                level: 8 // 지도의 확대 레벨
            };

        // 지도를 생성합니다
        var map = new kakao.maps.Map(mapContainer, mapOption);

        // 지도 확대, 축소 컨트롤에서 확대 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
        function zoomIn() {
            map.setLevel(map.getLevel() - 1);
        }

        // 지도 확대, 축소 컨트롤에서 축소 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
        function zoomOut() {
            map.setLevel(map.getLevel() + 1);
        }


        // 지도 이동
        function setCenter(y,x) {
            // 이동할 위도 경도 위치를 생성합니다
            var moveLatLon = new kakao.maps.LatLng(y, x);

            // 지도 중심을 이동 시킵니다
            //map.setCenter(moveLatLon);
            // 지도 중심을 부드럽게 이동시킵니다
            // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
            map.panTo(moveLatLon);
        }




        // ------------ 내 위치
        // ----------- 검색
        // 장소 검색 객체를 생성합니다
        // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
        var infowindow = new kakao.maps.InfoWindow({zIndex:8});
        // 처음들어갈 시 여행 제목 키워드로 장소를 검색합니다
        $(document).ready(function (){
                setMap();

        })
        function setMap(){
            infowindow.close();
            removeMarker();// 지도에 표시되고 있는 마커를 제거합니다
            setTimeout(function (){
                let places = myMerkerSet();
                displayPlaces(places);
            },100);
        }



        // 검색 결과 목록과 마커를 표출하는 함수입니다
        function displayPlaces(places) {

            var bounds = new kakao.maps.LatLngBounds();



            // 내가 저장한 마커 표시


            // 전달 받은 데이터의 마커를 생성하고 지도에 표시합니다
            for ( var i=0; i<places.length; i++ ) {
                var placePosition = new kakao.maps.LatLng(places[i].y, places[i].x),
                    marker = addMarker(placePosition, i, places[i]);


                // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                // LatLngBounds 객체에 좌표를 추가합니다
                bounds.extend(placePosition);

                // 마커와 검색결과 항목에 mouseover 했을때
                // 해당 장소에 인포윈도우에 장소명을 표시합니다
                // mouseout 했을 때는 인포윈도우를 닫습니다
                let info = places[i];
                (function(marker, info) {
                    kakao.maps.event.addListener(marker, 'click', function() {
                        displayInfowindow(marker, info);
                    });

                    $("#sortable li").onclick = function (){
                        console.log("클릭")
                        displayInfowindow(marker, info);
                    }
                })(marker, info);


            }


            function markeClose (){
                infowindow.close();
            }


            // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
            map.setBounds(bounds);
        }



        // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다. ------------------------------

        function myMerkerSet(){
            //일정 선택시 변경되는 imgOptions
            $("#sortable li").each(function (i,box){
                console.log($(box).find(".place_name").text());

                var positionsItem = {
                    content : '<div></div>',
                    latlng: new kakao.maps.LatLng($(box).attr('data-map-y'), $(box).attr('data-map-x')),
                    x: $(box).attr('data-map-x'),
                    y: $(box).attr('data-map-y'),
                    itemIndexArr:$(box).attr('data-index'),
                    mapIdArr :$(box).attr('data-map-id'),
                    place_name :$(box).find(".place_name").text(),
                    road_address_name :$(box).find(".road_address_name").text(),
                    address_name :$(box).find(".address_name").text()
                }
                positions.push(positionsItem);
            });
            return positions;
        }

        function addMarker(position, idx,place) {
            imageSrc ='/img/marker_number_blue.png';
            spriteSize = new kakao.maps.Size(35, 691);
            spriteOrigin= new kakao.maps.Point(0, (place.itemIndexArr*46)+10);
            offset = new kakao.maps.Point(13, 37);

            //기본 imgOptions
            imageSize = new kakao.maps.Size(36, 37);  // 마커 이미지의 크기

            var imgOptions =  {
                    spriteSize : spriteSize, // 스프라이트 이미지의 크기
                    spriteOrigin : spriteOrigin, // 스프라이트 이미지 중 사용할 영역의 좌상단 좌표
                    offset: offset // 마커 좌표에 일치시킬 이미지 내에서의 좌표
                },
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
                marker = new kakao.maps.Marker({
                    position: position, // 마커의 위치
                    image: markerImage
                });

            marker.setMap(map); // 지도 위에 마커를 표출합니다
            markers.push(marker);  // 배열에 생성된 마커를 추가합니다

            return marker;
        }

        // 지도 위에 표시되고 있는 마커를 모두 제거합니다
        function removeMarker() {
            for ( var i = 0; i < markers.length; i++ ) {
                console.log("제거----------------")
                markers[i].setMap(null);
            }
            positions = [];
            markers = [];
        }


        // 검색결과 목록 또는 마커를 클릭했을 때 호출되는 함수입니다
        // 인포윈도우에 장소명을 표시합니다
        function displayInfowindow(marker, info) {
            var iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다

            var content = '<div class="map_mark_info">';
            content += '<div class="map_mark_top mb-3">';
            content +=  '   <h5 class="place_name">'+ info.place_name+ '</h5>';
            content +=  '   <a href="javascript:infowindow.close()" class="btn btn-close"></a>'
            content += '</div>'
            content += '    <p class="jibun gray  road_address_name">' + info.road_address_name + '</p>';
            content += '    <p class="address_name">' +  info.address_name  + '</p>';
            content += '</div>';

            setCenter(info.y,info.x);
            infowindow.setContent(content);
            infowindow.open(map, marker);

        }




    });

    </script>




</th:block>
</html>

